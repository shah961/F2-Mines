<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | F¬≤ Mines Ecosystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg: #050109; --sidebar-bg: #0b0612; --card: #11081a; --text: #ffffff;
            --muted: #b3a9c9; --purple: #7c3aed; --purple-glow: #a855f7;
            --border: rgba(124, 58, 237, 0.2); --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }

        body.light-mode {
            --bg: #ffffff; --sidebar-bg: #ffffff; --card: #ffffff;
            --text: #0f172a; --muted: #64748b; --purple: #6d28d9; --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.3s; }
        body { background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* --- 2. SIDEBAR --- */
        aside {
            width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border);
            height: 100vh; position: fixed; left: 0; top: 0; z-index: 9999;
            display: flex; flex-direction: column; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-header { padding: 30px 20px; font-weight: 900; font-size: 20px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
        .sidebar-header span { background: var(--warning); color: #000; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transform: rotate(14deg); }
        .logo-b { transform: rotate(14deg); font-weight: 900; }

        .nav-list { list-style: none; padding: 20px 10px; flex: 1; }
        .nav-item {
            padding: 14px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer;
            color: var(--muted); font-weight: 600; display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(124, 58, 237, 0.1); color: var(--purple-glow); }
        .nav-item.active { border-left: 4px solid var(--purple); }

        #closeSidebar { position: absolute; right: 15px; top: 25px; background: none; border: none; color: var(--text); font-size: 30px; cursor: pointer; display: none; }

        /* --- 3. MAIN CONTENT --- */
        main { flex: 1; margin-left: 260px; padding: 30px; width: calc(100% - 260px); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        #menuBtn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 10px 15px; border-radius: 10px; cursor: pointer; display: none; font-weight: 700; }

        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        /* --- 4. PANELS & TABLES --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .stat-card h4 { font-size: 12px; color: var(--muted); text-transform: uppercase; margin-bottom: 8px; }
        .stat-card .val { font-size: 28px; font-weight: 900; }

        .panel { background: var(--card); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; margin-top: 20px; }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .table-wrap { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 750px; }
        th { text-align: left; background: rgba(124, 58, 237, 0.05); padding: 15px; font-size: 13px; color: var(--muted); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .bg-pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .bg-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .bg-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .btn { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 12px; transition: 0.2s; }
        .btn-edit { background: var(--purple); color: #fff; }
        .btn-del { background: var(--danger); color: #fff; }
        .btn-app { background: var(--success); color: #fff; }

        input, textarea, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; width: 100%; outline: none; margin-bottom: 15px; }
        textarea { min-height: 120px; font-family: 'Inter', sans-serif; resize: vertical; }

        /* --- 5. MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 3000; padding: 20px; }
        .modal-content { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 25px; width: 100%; max-width: 450px; overflow-y: auto; max-height: 90vh; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 992px) {
            aside { transform: translateX(-100%); }
            aside.open { transform: translateX(0); }
            main { margin-left: 0; width: 100%; }
            #menuBtn, #closeSidebar { display: block; }
        }
    /* Referral & Message Specific Styles */
.referral-row { border-left: 3px solid var(--purple); background: rgba(124, 58, 237, 0.03); }
.email-sub { font-size: 11px; color: var(--muted); display: block; }
.msg-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 15px;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.btn-delete-msg {
    margin-top: 15px;
    background: none;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    width: 100%;
    cursor: pointer;
}
    /* Mobile Optimized Tables & Cards */
.table-wrap {
    width: 100%;
    overflow-x: auto; /* Mobile par table scroll hogi, screen se bahar nahi jayegi */
    -webkit-overflow-scrolling: touch;
}

/* Inquiry/Message Card Styling */
.msg-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.msg-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    margin-bottom: 10px;
}

.msg-body {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.6;
}

.subject-tag {
    color: var(--warning);
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    display: block;
    margin-bottom: 5px;
}

/* Referral Table Specific */
#netTableBody tr td {
    white-space: nowrap; /* Text ko ek line mein rakhega scroll ke liye */
}

/* --- MOBILE RESPONSIVE FIX --- */
@media (max-width: 992px) {
    aside {
        transform: translateX(-100%); /* Sidebar ko screen se bahar rakhega */
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 9999;
    }

    aside.open {
        transform: translateX(0) !important; /* Menu dabane par sidebar andar aayega */
    }

    main {
        margin-left: 0 !important; /* Yeh sabse zaroori hai: Margin khatam karega */
        width: 100% !important;    /* Poori screen use karega */
        padding: 10px !important;  /* Side se thori space chor dega */
    }
.badge-count {
    background: var(--danger);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 50%;
    margin-left: auto;
}
    header {
        display: flex;
        flex-direction: row; /* Button aur Title ek line mein rahenge */
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
    }

    #secTitle {
        font-size: 18px !important; /* Title thora chota karega taake fit aaye */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .panel {
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
}
    </style>
</head>
<body>

    <!-- --- SIDEBAR --- -->
    <aside id="sidebar">
        <button id="closeSidebar" onclick="toggleSidebar()">&times;</button>
        <div class="sidebar-header"><span><b>‚Çø</b></span> F¬≤ ADMIN</div>
<ul class="nav-list">
    <li class="nav-item active" onclick="switchSection('dashboard', this)">üìä Dashboard</li>
    <li class="nav-item" onclick="switchSection('users', this)">üë• Users</li>
    <li class="nav-item" onclick="switchSection('txns', this)">
        üí∞ Transactions <span id="badge-txns" class="badge-count" style="display:none;">0</span>
    </li>
    <li class="nav-item" onclick="switchSection('miningReqs', this)">
        ‚õèÔ∏è Mining <span id="badge-mining" class="badge-count" style="display:none;">0</span>
    </li>
    <li class="nav-item" onclick="switchSection('messages', this)">
        üì© Inbox <span id="badge-msgs" class="badge-count" style="display:none;">0</span>
    </li>
    <li class="nav-item" onclick="switchSection('referralNetwork', this)">üï∏Ô∏è Referral Network</li>
    <li class="nav-item" onclick="switchSection('content', this)">‚úèÔ∏è Content</li>
    <li class="nav-item" onclick="switchSection('settings', this)">‚öôÔ∏è Settings</li>
</ul>
        <div style="padding:20px; border-top:1px solid var(--border);">
            <button onclick="location.href='index.html'" style="width:100%; padding:12px; background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); color:var(--danger); border-radius:10px; font-weight:700; cursor:pointer;">Exit Admin</button>
        </div>
    </aside>

    <!-- --- MAIN AREA --- -->
    <main>
        <header>
    <div style="display:flex; align-items:center; gap:10px; width: 100%;">
        <button id="menuBtn" onclick="toggleSidebar()" style="flex-shrink: 0;">‚ò∞ Menu</button>
        <h2 id="secTitle" style="margin: 20px; font-size: 20px;">Dashboard Overview</h2>
    </div>
    <!-- Dark Mode Toggle Button yahan alag se flex mein side par rahega -->
</header>

        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card"><h4>Total Users</h4><div class="val" id="stUsers">0</div></div>
                <div class="stat-card"><h4>System Deposits</h4><div class="val" id="stDeps" style="color:var(--success)">$0</div></div>
                <div class="stat-card"><h4>Active Miners</h4><div class="val" id="stActive">0</div></div>
            </div>
            <div class="panel" style="padding:25px; text-align:center;">
                <p style="color:var(--muted)">Admin Access: <b style="color:var(--success)">Verified</b></p>
            </div>
        </div>

        <!-- USER DATABASE -->
        <div id="users" class="section">
            <div class="panel">
                <div class="panel-header"><h3>User Management</h3></div>
                <div class="table-wrap">
                    <table>
                      <div class="panel-header">
    <h3>User Management (<span id="userCount">0</span>)</h3>
    <!-- Naya Search Box -->
    <input type="text" id="userSearch" placeholder="Search by Email or Name..." style="width: 250px; margin-bottom: 0; padding: 8px 15px; font-size: 13px;">
</div>
                        <thead><tr><th>User Info</th><th>Balance</th><th>Hashrate</th><th>Actions</th></tr></thead>
                        <tbody id="uTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRANSACTIONS -->
<!-- TRANSACTIONS SECTION (SPLIT) -->
<div id="txns" class="section">
    <!-- DEPOSITS PANEL -->
    <div class="panel">
        <div class="panel-header"><h3>üì• Pending Deposits</h3></div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>User</th><th>Amount</th><th>Method/TID</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="depTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- WITHDRAWALS PANEL -->
    <div class="panel" style="margin-top:30px;">
        <div class="panel-header"><h3>üì§ Withdrawal Requests</h3></div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>User</th><th>Amount</th><th>Account Details</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="withTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
<!-- MINING REQUESTS SECTION -->
<div id="miningReqs" class="section">
    <div class="panel">
        <div class="panel-header"><h3>‚õèÔ∏è Pending Mining Approvals</h3></div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>User</th><th>Coin</th><th>Hashrate</th><th>Profit</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="miningTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
        <!-- WEBSITE CONTENT EDITOR (NEW SECTION) -->
        <div id="content" class="section">
            <div class="panel" style="padding:25px;">
                <h3>üìù Website Content Management</h3>
                <p style="color:var(--muted); margin-bottom:25px;">Edit live content that appears on your website pages.</p>

                <!-- Hero Section Editor -->
                <div style="margin-bottom:30px;">
                    <h4 style="color:var(--purple-glow); margin-bottom:10px;">üè† Landing Page Hero</h4>
                    <label style="font-size:12px; color:var(--muted);">Hero Title</label>
                    <input type="text" id="content_hero_title" placeholder="THE SMARTEST WAY TO MINE CRYPTO">
                    
                    <label style="font-size:12px; color:var(--muted);">Hero Description</label>
                    <textarea id="content_hero_desc" placeholder="Maximize your returns with our institutional-grade mining hardware..."></textarea>
                </div>

                <!-- Contact Page Editor -->
                <div style="margin-bottom:30px; padding-top:20px; border-top:1px solid var(--border);">
                    <h4 style="color:var(--purple-glow); margin-bottom:10px;">üìß Contact Page Info</h4>
                    <label style="font-size:12px; color:var(--muted);">Email Support</label>
                    <input type="text" id="content_contact_email" placeholder="muhammadanventures@gmail.com">
                    
                    <label style="font-size:12px; color:var(--muted);">Email Description</label>
                    <input type="text" id="content_contact_email_desc" placeholder="Response within 24 hours.">
                    
                    <label style="font-size:12px; color:var(--muted);">Live Support Timing</label>
                    <input type="text" id="content_contact_support" placeholder="Mon-Fri: 9am - 6pm EST">
                    
                    <label style="font-size:12px; color:var(--muted);">Security Email</label>
                    <input type="text" id="content_contact_security" placeholder="security-dept@f2mines.com">
                </div>

                <!-- Terms & Conditions Editor -->
                <div style="margin-bottom:30px; padding-top:20px; border-top:1px solid var(--border);">
                    <h4 style="color:var(--purple-glow); margin-bottom:10px;">üìú Terms & Conditions</h4>
                    <label style="font-size:12px; color:var(--muted);">Full Terms Content (HTML Supported)</label>
                    <textarea id="content_terms" style="min-height:200px;" placeholder="Enter your complete terms and conditions..."></textarea>
                    <small style="color:var(--muted); display:block; margin-top:-10px;">üí° Tip: You can use HTML tags like &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;</small>
                </div>

                <button class="btn btn-edit" style="width:100%; padding:15px;" onclick="saveWebsiteContent()">üíæ Save All Website Content</button>
            </div>
        </div>

        <!-- WALLET SETTINGS -->
        <div id="settings" class="section">
            <div class="panel" style="padding:25px;">
                <h3>Deposit Wallet Settings</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                    <div>
                      <label style="font-size:12px;">WhatsApp no. with Country code (e.g 92) </label>
<input type="text" id="s_wa_num" placeholder="WhatsApp no.">
                        <label style="font-size:12px;">JazzCash Name</label><input type="text" id="s_jc_name">
                        <label style="font-size:12px;">JazzCash Number</label><input type="text" id="s_jc_num">
                    </div>
                    <div>
                        <label style="font-size:12px;">EasyPaisa Name</label><input type="text" id="s_ep_name">
                        <label style="font-size:12px;">EasyPaisa Number</label><input type="text" id="s_ep_num">
                    </div>
                </div>
                <label style="font-size:12px;">Binance USDT (TRC20) Address</label><input type="text" id="s_binance">
                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
    <h4>Referral Rewards</h4>
    <label>Bonus Amount ($)</label><input type="number" id="ref_bonus" step="0.01">
    <label>Mining Boost (TH/s)</label><input type="number" id="ref_boost" step="0.1">
    <label>Referral Enabled?</label>
    <select id="ref_enabled"><option value="true">Yes</option><option value="false">No</option></select>
</div>
                <button class="btn btn-edit" style="width:100%; padding:15px;" onclick="saveAdminSettings()">Save All Wallet Data</button>
            </div>
        </div>
    </main>

    <!-- EDIT USER MODAL -->
    <div id="editModal" class="modal"><div class="modal-content">
        <h3>Full Profile Control</h3>
        <p id="eEmail" style="color:var(--purple-glow); font-size:12px; margin:10px 0;"></p>
        
        <label style="font-size:11px;">Edit Full Name</label><input type="text" id="eNameDisplay">
        <label style="font-size:11px;">Edit Phone Number</label><input type="text" id="ePhoneDisplay">
        <label style="font-size:11px;">Update Balance ($)</label><input type="number" id="eBalance">
        <label style="font-size:11px;">Update Hashrate (TH/s)</label><input type="number" id="eHash">
        
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-app" style="flex:1; padding:12px;" onclick="saveUserEdit()">Apply Changes</button>
            <button class="btn btn-del" style="flex:1; padding:12px;" onclick="closeModal()">Cancel</button>
        </div>
    </div></div>
    <!-- MESSAGES SECTION -->
<div id="messages" class="section">
    <div class="panel">
        <div class="panel-header">
            <h3>üì© User Inquiry Inbox</h3>
        </div>
        <!-- Is container mein table nahi, direct cards aayenge -->
        <div id="messagesList" style="padding: 15px; background: var(--bg);">
            <p style="color:var(--muted); text-align:center;">Loading messages...</p>
        </div>
    </div>
</div>
    <!-- REFERRAL NETWORK SECTION -->
<div id="referralNetwork" class="section">
    <div class="panel">
        <div class="panel-header">
            <h3>üï∏Ô∏è Referral Network Tree</h3>
        </div>
        <div class="table-wrap">
            <table style="min-width: 600px;"> <!-- Min-width se mobile par scroll aayega -->
                <thead>
                    <tr>
                        <th>Referrer (Leader)</th>
                        <th>New User (Joined)</th>
                        <th>Join Date</th>
                        <th>Bonus</th>
                    </tr>
                </thead>
                <tbody id="netTableBody">
                    <!-- JS yahan row add karega -->
                </tbody>
            </table>
        </div>
        <p style="padding: 15px; font-size: 11px; color: var(--muted); text-align: center;">
            üí° Swipe left/right on the table to see full details on mobile.
        </p>
    </div>
</div>
    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAiVujpar4bp-eCGZTEaCu6VKwhsJG7J3I",
        authDomain: "f2mines1.firebaseapp.com",
        databaseURL: "https://f2mines1-default-rtdb.firebaseio.com",
        projectId: "f2mines1",
        storageBucket: "f2mines1.firebasestorage.app",
        messagingSenderId: "546591819609",
        appId: "1:546591819609:web:97e8009b59fc3cdf44ee48"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let dbSnapshot = {};
    let editTargetUid = '';

    // --- 2. GLOBAL WINDOW FUNCTIONS (Har click isi se chalega) ---
    window.toggleSidebar = () => {
        const sb = document.getElementById('sidebar');
        if(sb) sb.classList.toggle('open');
    };

    window.switchSection = (id, el) => {
        // Sections show/hide
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');
        
        // Header Title change
        const titleEl = document.getElementById('secTitle');
        if(titleEl && el) titleEl.innerText = el.innerText;

        // Active link highlight
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');

        // Mobile sidebar close
        if(window.innerWidth < 992) {
            document.getElementById('sidebar').classList.remove('open');
        }
    };

    window.saveAdminSettings = () => {
        const s = {
          // window.saveAdminSettings ke andar s object mein:
wa_num: document.getElementById('s_wa_num').value,
            jc_name: document.getElementById('s_jc_name').value,
            jc_num: document.getElementById('s_jc_num').value,
            ep_name: document.getElementById('s_ep_name').value,
            ep_num: document.getElementById('s_ep_num').value,
            binance_addr: document.getElementById('s_binance').value,
            referral: {
                bonusAmount: parseFloat(document.getElementById('ref_bonus').value) || 0,
                miningBoost: parseFloat(document.getElementById('ref_boost').value) || 0,
                enabled: document.getElementById('ref_enabled').value === "true"
            }
        };
        set(ref(db, 'settings'), s).then(() => alert("All Settings Saved!"));
    };

    window.saveWebsiteContent = () => {
        const c = {
            hero_title: document.getElementById('content_hero_title').value,
            hero_desc: document.getElementById('content_hero_desc').value,
            contact_email: document.getElementById('content_contact_email').value,
            contact_email_desc: document.getElementById('content_contact_email_desc').value,
            contact_support: document.getElementById('content_contact_support').value,
            contact_security: document.getElementById('content_contact_security').value,
            terms: document.getElementById('content_terms').value
        };
        set(ref(db, 'siteContent'), c).then(() => alert("Website Content Updated!"));
    };
function renderMiningRequests() {
    const txns = dbSnapshot.transactions || {};
    // Sirf Mining Profit dikhayega
    const miningTxns = Object.entries(txns).filter(([id, t]) => t.type === 'Mining Profit');

    document.getElementById('miningTableBody').innerHTML = miningTxns.map(([tid, t]) => `
    <tr>
        <td><small>${t.email}</small></td>
        <td><b>${t.method}</b></td>
        <td><small>${t.hashrate || '0'} TH/s</small></td> <!-- Ye column add kiya -->
        <td><b style="color:var(--success)">$${t.amount}</b></td>
        <td><span class="badge ${t.status==='Approved'?'bg-success':'bg-pending'}">${t.status}</span></td>
        <td>
            ${t.status === 'Pending' ? `
                <button class="btn btn-app" onclick="processTxn('${tid}', '${t.uid}', ${t.amount}, 'Mining Profit', 'Approved')">Confirm Profit</button>
                <button class="btn btn-del" onclick="processTxn('${tid}', '', 0, 'Mining Profit', 'Rejected')">Decline</button>
            ` : `<button class="btn btn-del" onclick="clearTxnLog('${tid}')">Clear</button>`}
        </td>
    </tr>
`).join('') || '<tr><td colspan="6">No mining requests.</td></tr>';
}
    // admin.html ke processTxn function ko behtar banayein:
window.processTxn = async (tid, uid, amt, type, status) => {
    const updates = {};
    updates[`transactions/${tid}/status`] = status;

    if (status === 'Approved' && uid) {
        const currentBal = dbSnapshot.users[uid]?.balance || 0;
        const currentHash = dbSnapshot.users[uid]?.hashrate || 0;
        const txnData = dbSnapshot.transactions[tid];

        if (type === 'Deposit' || type === 'Mining Profit') {
            updates[`users/${uid}/balance`] = currentBal + amt;
        } 
        else if (type === 'Referral Bonus') {
            // Balance + Hashrate Boost dono update honge
            updates[`users/${uid}/balance`] = currentBal + amt;
            updates[`users/${uid}/hashrate`] = currentHash + (txnData.hashrateBoost || 0);
            
            // Referrer ki list mein status 'Completed' karna
            if(txnData.newUserUid) {
                updates[`referrals/${uid}/${txnData.newUserUid}/status`] = 'Completed';
            }
        }
        else if (type === 'Withdrawal') {
            updates[`users/${uid}/balance`] = currentBal - amt;
        }
    }
    await update(ref(db), updates);
    alert("Process Completed & List Updated!");
};
        

    window.openUserEditor = (uid) => {
        editTargetUid = uid;
        const u = dbSnapshot.users[uid];
        document.getElementById('eEmail').innerText = u.email;
        document.getElementById('eNameDisplay').value = u.name || '';
        document.getElementById('ePhoneDisplay').value = u.phone || '';
        document.getElementById('eBalance').value = u.balance || 0;
        document.getElementById('eHash').value = u.hashrate || 0;
        document.getElementById('editModal').style.display = 'flex';
    };

    window.saveUserEdit = () => {
        const up = {
            name: document.getElementById('eNameDisplay').value,
            phone: document.getElementById('ePhoneDisplay').value,
            balance: parseFloat(document.getElementById('eBalance').value),
            hashrate: parseFloat(document.getElementById('eHash').value)
        };
        update(ref(db, `users/${editTargetUid}`), up).then(() => {
            alert("User Updated!");
            window.closeModal();
        });
    };

    window.closeModal = () => document.getElementById('editModal').style.display = 'none';
    window.deleteUserData = (uid) => { if(confirm("Delete user?")) remove(ref(db, `users/${uid}`)); };
    window.deleteInquiry = (mid) => remove(ref(db, `messages/${mid}`));
    window.clearTxnLog = (tid) => remove(ref(db, `transactions/${tid}`));

    // --- 3. RENDERING ENGINE (Data ko screen par dikhana) ---
    function refreshAdminPanel() {
    renderStats();
    renderUserTable();
    renderTransactionTable();
    renderInquiryInbox();
    renderReferralNetwork();
    renderMiningRequests(); // Ye line add karein
    populateFields();
}

    function renderStats() {
    const users = Object.values(dbSnapshot.users || {});
    const txns = Object.values(dbSnapshot.transactions || {});
    const msgs = Object.values(dbSnapshot.messages || {});

    // Stats calculation
    document.getElementById('stUsers').innerText = users.length;
    document.getElementById('stActive').innerText = users.filter(u => u.hashrate > 0).length;
    const totalDep = txns.filter(t => t.type === 'Deposit' && t.status === 'Approved')
                         .reduce((acc, curr) => acc + (curr.amount || 0), 0);
    document.getElementById('stDeps').innerText = "$" + totalDep.toLocaleString();

    // --- NOTIFICATION BADGES LOGIC ---
    
    // 1. Pending Transactions (Deposit + Withdrawal)
    const pendingTxns = txns.filter(t => t.status === 'Pending' && t.type !== 'Mining Profit').length;
    updateBadge('badge-txns', pendingTxns);

    // 2. Pending Mining Profits
    const pendingMining = txns.filter(t => t.status === 'Pending' && t.type === 'Mining Profit').length;
    updateBadge('badge-mining', pendingMining);

    // 3. New Messages
    const pendingMsgs = msgs.length;
    updateBadge('badge-msgs', pendingMsgs);
}

// Helper function badge ko show/hide karne ke liye
function updateBadge(id, count) {
    const el = document.getElementById(id);
    if (el) {
        if (count > 0) {
            el.innerText = count;
            el.style.display = 'inline-block';
        } else {
            el.style.display = 'none';
        }
    }
}

    function renderUserTable() {
    const users = dbSnapshot.users || {};
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const userEntries = Object.entries(users);
    
    // Total users count update karein
    document.getElementById('userCount').innerText = userEntries.length;

    // Filter karein search ke mutabiq
    const filteredUsers = userEntries.filter(([uid, u]) => {
        const name = (u.name || '').toLowerCase();
        const email = (u.email || '').toLowerCase();
        return name.includes(searchTerm) || email.includes(searchTerm);
    });

    document.getElementById('uTableBody').innerHTML = filteredUsers.map(([uid, u]) => `
        <tr>
            <td><b>${u.name || 'User'}</b><br><small>${u.email}</small></td>
            <td style="color:var(--success)">$${(u.balance || 0).toFixed(2)}</td>
            <td>${u.hashrate || 0} TH/s</td>
            <td>
                <button class="btn btn-edit" onclick="openUserEditor('${uid}')">Edit</button>
                <button class="btn btn-del" onclick="deleteUserData('${uid}')">Del</button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4">No users found.</td></tr>';
}

// Search input par event listener lagayein (taake likhte hi filter ho)
document.getElementById('userSearch').addEventListener('input', renderUserTable);

    function renderTransactionTable() {
    const txns = dbSnapshot.transactions || {};
    const txnsArray = Object.entries(txns);

    // 1. DEPOSITS RENDER
    const deposits = txnsArray.filter(([id, t]) => t.type === 'Deposit' || t.type === 'Referral Bonus');
    document.getElementById('depTableBody').innerHTML = deposits.map(([tid, t]) => `
        <tr>
            <td><small>${t.email}</small></td>
            <td><b style="color:var(--success)">$${t.amount}</b></td>
            <td><small><b>${t.method}</b><br>TID: ${t.proof || 'N/A'}</small></td>
            <td><span class="badge ${t.status==='Approved'?'bg-success': t.status==='Rejected'?'bg-danger':'bg-pending'}">${t.status}</span></td>
            <td>
                ${t.status === 'Pending' ? `
                    <button class="btn btn-app" onclick="processTxn('${tid}', '${t.uid}', ${t.amount}, 'Deposit', 'Approved')">Approve</button>
                    <button class="btn btn-del" onclick="processTxn('${tid}', '', 0, 'Deposit', 'Rejected')">Reject</button>
                ` : `<button class="btn btn-del" onclick="clearTxnLog('${tid}')">Clear</button>`}
            </td>
        </tr>
    `).join('') || '<tr><td colspan="5">No deposit records.</td></tr>';

    // 2. WITHDRAWALS RENDER
    const withdrawals = txnsArray.filter(([id, t]) => t.type === 'Withdrawal');
    document.getElementById('withTableBody').innerHTML = withdrawals.map(([tid, t]) => `
        <tr>
            <td><small>${t.email}</small></td>
            <td><b style="color:var(--danger)">$${t.amount}</b></td>
            <td><small><b>${t.method}</b><br>${t.details || 'N/A'}</small></td>
            <td><span class="badge ${t.status==='Approved'?'bg-success': t.status==='Rejected'?'bg-danger':'bg-pending'}">${t.status}</span></td>
            <td>
                ${t.status === 'Pending' ? `
                    <button class="btn btn-app" onclick="processTxn('${tid}', '${t.uid}', ${t.amount}, 'Withdrawal', 'Approved')">Paid</button>
                    <button class="btn btn-del" onclick="processTxn('${tid}', '', 0, 'Withdrawal', 'Rejected')">Reject</button>
                ` : `<button class="btn btn-del" onclick="clearTxnLog('${tid}')">Clear</button>`}
            </td>
        </tr>
    `).join('') || '<tr><td colspan="5">No withdrawal requests.</td></tr>';
}

    window.renderReferralNetwork = () => {
    const tbody = document.getElementById('netTableBody');
    const referrals = dbSnapshot.referrals || {};
    const users = dbSnapshot.users || {};
    
    let rows = "";
    Object.entries(referrals).forEach(([referrerUid, friends]) => {
        const rName = users[referrerUid]?.name || "User";
        const rEmail = users[referrerUid]?.email || "N/A";

        Object.entries(friends).forEach(([fUid, d]) => {
            rows += `
                <tr class="referral-row">
                    <td>
                        <b style="color:var(--purple-glow)">${rName}</b>
                        <span class="emailsub">${rEmail}</span>
                    </td>
                    <td>
                        <b>${d.friendName}</b>
                        <span class="email-sub">${users[fUid]?.email || 'New User'}</span>
                    </td>
                    <td><small>${d.joinDate}</small></td>
                    <td><span class="badge bg-success">$${d.rewardEarned}</span></td>
                </tr>
            `;
        });
    });
    tbody.innerHTML = rows || '<tr><td colspan="4" style="text-align:center; padding:20px;">No referral data found.</td></tr>';
};

window.renderInquiryInbox = () => {
    const container = document.getElementById('messagesList');
    const msgs = dbSnapshot.messages || {};
    
    const msgKeys = Object.keys(msgs);
    if (msgKeys.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:var(--muted); padding:40px;">No messages found.</p>';
        return;
    }

    container.innerHTML = Object.entries(msgs).map(([mid, m]) => `
        <div class="msg-card" id="msg-${mid}">
            <div class="msg-header">
                <div>
                    <b style="font-size:14px; color:var(--text);">${m.name}</b>
                    <small style="display:block; color:var(--purple-glow); font-size:11px;">${m.email}</small>
                </div>
                <small style="color:var(--muted); font-size:10px;">${m.date}</small>
            </div>
            <div class="msg-body">
                <span class="subject-tag">Subject: ${m.subject || 'N/A'}</span>
                <p>${m.message}</p>
            </div>
            
            <!-- DELETE BUTTON -->
            <button class="btn btn-del" 
                    style="width:100%; margin-top:10px; padding:10px; background:rgba(239, 68, 68, 0.1); border:1px solid var(--danger); color:var(--danger);" 
                    onclick="confirmDeleteMsg('${mid}')">
                üóëÔ∏è Delete Message
            </button>
        </div>
    `).reverse().join('');
};
window.confirmDeleteMsg = (mid) => {
    if (confirm("Are you sure you want to delete this message permanently?")) {
        // Firebase database se message delete karein
        const { ref, remove } = window.fbDb; // Ya jo bhi aapne db initialize kiya hai
        remove(ref(db, `messages/${mid}`))
        .then(() => {
            alert("Message Deleted!");
        })
        .catch((error) => {
            alert("Error: " + error.message);
        });
    }
};

    function populateFields() {
        const s = dbSnapshot.settings || {};
        const c = dbSnapshot.siteContent || {};
        const safeSet = (id, val) => {
            const el = document.getElementById(id);
            if (el && !el.matches(':focus')) el.value = val || '';
        };
        // populateFields ke andar s object se value uthane ke liye:
safeSet('s_wa_num', s.wa_num);
        safeSet('s_jc_name', s.jc_name); safeSet('s_jc_num', s.jc_num);
        safeSet('s_ep_name', s.ep_name); safeSet('s_ep_num', s.ep_num);
        safeSet('s_binance', s.binance_addr);
        safeSet('ref_bonus', s.referral?.bonusAmount);
        safeSet('ref_boost', s.referral?.miningBoost);
        safeSet('ref_enabled', s.referral?.enabled ? "true" : "false");
        safeSet('content_hero_title', c.hero_title);
        safeSet('content_hero_desc', c.hero_desc);
        safeSet('content_contact_email', c.contact_email);
        safeSet('content_contact_email_desc', c.contact_email_desc);
        safeSet('content_contact_support', c.contact_support);
        safeSet('content_contact_security', c.contact_security);
        safeSet('content_terms', c.terms);
    }

    // --- 4. DATA LISTENER (Real-time update) ---
    onValue(ref(db, '/'), (snapshot) => {
        dbSnapshot = snapshot.val() || {};
        refreshAdminPanel();
    });

</script>
</body>
</html>
